# ============================================
# GoShort CI/CD Pipeline
# Blue-Green Deployment with Zero Downtime
# ============================================

stages:
  - quality
  - security
  - test
  - build
  - deploy

variables:
  CI_REGISTRY_IMAGE: registry.gitlab.com/$CI_PROJECT_PATH
  TAG_COMMIT: $CI_COMMIT_SHORT_SHA
  TAG_LATEST: latest
  TAG_BRANCH: $CI_COMMIT_REF_SLUG
  DEPLOY_PATH: "/opt/goshort"
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: unix:///var/run/docker.sock

# ============================================
# Backend Jobs
# ============================================

lint_backend:
  stage: quality
  image: golangci/golangci-lint:v1.61.0
  tags: [vps-runner]
  script:
    - cd backend
    - golangci-lint run --timeout 10m --verbose ./...
  only:
    - merge_requests
    - main
    - develop
  cache:
    key: ${CI_COMMIT_REF_SLUG}-backend
    paths:
      - backend/.cache

security_scan_backend:
  stage: security
  image: golang:1.23-alpine
  tags: [vps-runner]
  before_script:
    - apk add --no-cache git
    - go install github.com/securego/gosec/v2/cmd/gosec@v2.19.0
  script:
    - cd backend
    - $(go env GOPATH)/bin/gosec -severity medium -confidence medium -fmt json -out gosec-report.json ./... || echo "gosec completed with warnings"
    - $(go env GOPATH)/bin/gosec -severity medium -confidence medium ./... || true
  artifacts:
    reports:
      sast: backend/gosec-report.json
    expire_in: 1 week
    when: always
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true

sast_backend:
  stage: security
  image: returntocorp/semgrep:latest
  tags: [vps-runner]
  script:
    - cd backend
    - semgrep --config auto --json --output semgrep-report.json ./... || echo "Semgrep scan completed"
    - semgrep --config auto ./... || true
  artifacts:
    reports:
      sast: backend/semgrep-report.json
    expire_in: 1 week
    when: always
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true

dependency_scan_backend:
  stage: security
  image: golang:1.23-alpine
  tags: [vps-runner]
  before_script:
    - apk add --no-cache git
    - go install golang.org/x/vuln/cmd/govulncheck@latest
  script:
    - cd backend
    - $(go env GOPATH)/bin/govulncheck ./... || echo "Vulnerability scan completed"
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true

unit_test_backend:
  stage: test
  image: golang:1.23-alpine
  tags: [vps-runner]
  services:
    - name: postgres:15-alpine
      alias: postgres
    - name: redis:7-alpine
      alias: redis
  variables:
    POSTGRES_DB: goshort_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres123
    POSTGRES_HOST_AUTH_METHOD: trust
    DB_HOST: postgres
    DB_PORT: "5432"
    DB_USER: postgres
    DB_PASSWORD: postgres123
    DB_NAME: goshort_test
    DB_SSLMODE: disable
    REDIS_HOST: redis
    REDIS_PORT: "6379"
    REDIS_PASSWORD: ""
    CGO_ENABLED: "1"
    LOG_LEVEL: error
    ENVIRONMENT: test
  before_script:
    - apk add --no-cache gcc musl-dev postgresql-client
    - |
      echo "Waiting for PostgreSQL..."
      for i in {1..30}; do
        if pg_isready -h postgres -U postgres; then
          echo "PostgreSQL is ready!"
          break
        fi
        echo "Waiting... ($i/30)"
        sleep 2
      done
    - |
      echo "Waiting for Redis..."
      for i in {1..30}; do
        if nc -z redis 6379; then
          echo "Redis is ready!"
          break
        fi
        echo "Waiting... ($i/30)"
        sleep 2
      done
    - cd backend
    - go mod download
  script:
    - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
    - go tool cover -func=coverage.out | tail -1
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.out
    paths:
      - backend/coverage.out
    expire_in: 1 week
    when: always
  only:
    - merge_requests
    - main
    - develop
  allow_failure: false

# ============================================
# Frontend Jobs
# ============================================

lint_frontend:
  stage: quality
  image: node:20-alpine
  tags: [vps-runner]
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run lint || true
  cache:
    key: ${CI_COMMIT_REF_SLUG}-frontend
    paths:
      - frontend/node_modules/
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true

security_scan_frontend:
  stage: security
  image: node:20-alpine
  tags: [vps-runner]
  before_script:
    - cd frontend
